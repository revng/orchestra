#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:template", "template")
#@ load("/lib/create-component.lib.yml", "single_build_component")
#@ load("/lib/fn-args.lib.yml", "mandatory")

#@yaml/text-templated-strings
---
#@ def revng_distributable(name=mandatory, components=mandatory):
configure: |
  set -x
  mkdir -p "$BUILD_DIR"
install: |
  set -x
  echo asd
  INSTALLER="$ORCHESTRA_DOTDIR/support/revng-distributable/install.sh"
  echo "18b1d1953a71c851a64f9fd2c57ca079c4a93434a50edc5c417d590d6a7e9096 $INSTALLER" | \
    sha256sum --quiet -c -
  timeout 600 "$INSTALLER" "(@= name @)" "(@= "\" \"".join(components) @)" |& tail -n 10000 || true
  df -h
  exit 1
build_dependencies:
  - test/revng-qa
  - #@ template.replace(components)
skip_post_install: true
#@ end

#@overlay/match by=overlay.all, expects=1
#@overlay/match-child-defaults missing_ok=True
---
components:
  revng-distributable: #@ single_build_component(**revng_distributable("revng", ["revng-c"]))
  revng-distributable-public-demo: #@ single_build_component(**revng_distributable("revng-public-demo", ["revng-c", "toolchain/host/gcc"]))
