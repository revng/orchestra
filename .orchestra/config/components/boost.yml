#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:data", "data")

#@ load("/lib/create_component.lib.yml", "single_build_component")

#@yaml/text-templated-strings
---
#@ def boost(is_windows):
license: LICENSE_1_0.txt
configure: |
  mkdir -p "$BUILD_DIR"

  extract.sh --into "$BUILD_DIR" "https://downloads.sourceforge.net/project/boost/boost/1.72.0/boost_1_72_0.tar.bz2"
  patch-if-exists "${ORCHESTRA_DOTDIR}/patches/boost-1.63.0-icl-disable-LessThanComparableConcept.patch" "$BUILD_DIR"
  cd "$BUILD_DIR" && ./bootstrap.sh --prefix="$ORCHESTRA_ROOT" --with-libraries=test
install: |
  cd "$BUILD_DIR"

  (@- if is_windows: @)

  echo "using clang : : x86_64-w64-mingw32-clang++ -pthread -stdlib=libc++ -D_WIN32_WINNT=0x6000 -D_LIBCPP_HAS_THREAD_API_WIN32 -fvisibility-inlines-hidden -fvisibility=hidden -fgnuc-version=4.8.0 : ;" > user-config.jam

  ./b2 \
    --user-config=user-config.jam \
    --with-test \
    --prefix="${DESTDIR}${ORCHESTRA_ROOT}/x86_64-w64-mingw32" \
    --ignore-site-config \
    address-model=64 \
    architecture=x86 \
    variant=release \
    link=shared \
    toolset=clang \
    target-os=windows

  ./b2 \
    --user-config=user-config.jam \
    --with-test \
    --prefix="${DESTDIR}${ORCHESTRA_ROOT}/x86_64-w64-mingw32" \
    --ignore-site-config \
    address-model=64 \
    architecture=x86 \
    variant=release \
    link=shared \
    toolset=clang \
    target-os=windows \
    install

  (@- else: @)

   ./b2 \
     --prefix="${DESTDIR}${ORCHESTRA_ROOT}" \
     --ignore-site-config toolset='clang'

   ./b2 \
     --prefix="${DESTDIR}${ORCHESTRA_ROOT}" \
     --ignore-site-config toolset='clang' \
     install

  (@- end @)

build_dependencies:
  - host-cxx-toolchain
  - glibc
dependencies:
  - host-libcxx
  - libunwind
#@ end

#@overlay/match by=overlay.all, expects=1
#@overlay/match-child-defaults missing_ok=True
---
components:
  boost: #@ single_build_component(**boost(False))
  windows/boost: #@ single_build_component(**boost(True))
