#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ load("/lib/make.lib.yml", "make")
#@ load("/lib/shell.lib.yml", "expand_args")
#@ load("/lib/optimization_flavors.lib.yml", "qt_optimization_flavors")

#@yaml/text-templated-strings
---
#@ def _configure_base(is_windows, extra_qmake_options=""):
- |
  mkdir -p "$BUILD_DIR"
  cd "$BUILD_DIR";

  $SOURCE_DIR/configure \
    -recheck-all \
    -confirm-license \
    -opensource \
    -skip qt3d \
    -skip qtactiveqt \
    -skip qtandroidextras  \
    -skip qtcanvas3d  \
    -skip qtcharts  \
    -skip qtconnectivity  \
    -skip qtdatavis3d  \
    -skip qtgamepad  \
    -skip qtimageformats  \
    -skip qtlocation  \
    -skip qtmacextras  \
    -skip qtmultimedia  \
    -skip qtnetworkauth  \
    -skip qtpurchasing  \
    -skip qtremoteobjects  \
    -skip qtscript  \
    -skip qtscxml  \
    -skip qtsensors  \
    -skip qtserialbus  \
    -skip qtserialport  \
    -skip qtsvg  \
    -skip qtspeech  \
    -skip qttools  \
    -skip qttranslations  \
    -skip qtvirtualkeyboard  \
    -skip qtwebchannel  \
    -skip qtwebsockets  \
    -skip qtwebview  \
    -skip qtwinextras  \
    -skip qtxmlpatterns  \
    -skip qtwebengine \
    -no-glib \
    -no-cups \
    -no-gtk \
    -qt-harfbuzz \
    -opengl desktop \
    -no-icu \
    -no-zstd \
    -qt-libpng \
    -qt-libjpeg \
    -qt-sqlite \
    -qt-pcre \
    -qt-zlib \
    -qt-doubleconversion \
    -sql-sqlite \
    -no-sql-odbc \
    -no-compile-examples \
    -nomake tests \
    -nomake examples \
    -c++std c++14 \
    (@- if is_windows: @)
    -prefix "$ORCHESTRA_ROOT/x86_64-w64-mingw32" \
    -xplatform win32-clang-g++ \
    -device-option CROSS_COMPILE=x86_64-w64-mingw32- \
    QMAKE_CXXFLAGS+="-D_WIN32_WINNT=0x6000 -D_LIBCPP_HAS_THREAD_API_WIN32" \
    QMAKE_LFLAGS+="-pthread" \
    (@- else: @)
    -prefix "$ORCHESTRA_ROOT" \
    -openssl-runtime \
    -fontconfig \
    -system-freetype \
    -egl \
    -no-eglfs \
    -xcb \
    -xkbcommon \
    -libinput \
    -platform linux-clang \
    (@- end @)
    -no-pch \
    (@= extra_qmake_options @)
#@ end

#@ def configure_base(*args, **kwargs):
#@    return _configure_base(*args, **kwargs)[0]
#@ end


#@yaml/text-templated-strings
---
#@ def qt_component(is_windows):
license: LICENSE.GPLv3
default_build: optimized
builds:
  #@ for flavor, opts in qt_optimization_flavors.items():
  #@ extra_qmake_options = opts["extra_qmake_options"]
  #@ ndebug = opts["ndebug"]
  (@= flavor @):
    configure: |
      extract.sh --into "$SOURCE_DIR" https://download.qt.io/official_releases/qt/5.15/5.15.2/single/qt-everywhere-src-5.15.2.tar.xz
      patch-if-exists "${ORCHESTRA_DOTDIR}/patches/qt-5.13.1-libcxx-include-array-linuxdmabuf.patch" "$SOURCE_DIR"

      sed -i 's|QT_CONFIG(getauxval)|0|' "$SOURCE_DIR/qtbase/src/corelib/global/qrandom.cpp"

      (@= configure_base(is_windows, extra_qmake_options=extra_qmake_options) @)
    install: |
      cd "$BUILD_DIR"

      (@= make @)
      (@= make @) install INSTALL_ROOT=$TMP_ROOT


      (@ if is_windows: @)
      mkdir -p "${TMP_ROOT}${ORCHESTRA_ROOT}/x86_64-w64-mingw32"
      cd "${TMP_ROOT}${ORCHESTRA_ROOT}/x86_64-w64-mingw32"
      cp -ar "${TMP_ROOT}${BUILD_DIR}/qtbase/bin/C:/Qt/"Qt-*/. .
      LIBDIR=lib
      (@ else: @)
      LIBDIR=lib64
      cd "${TMP_ROOT}${ORCHESTRA_ROOT}"
      (@ end @)

      rm "$LIBDIR/cmake/Qt5Gui/Qt5GuiConfigExtras.cmake"
      touch "$LIBDIR/cmake/Qt5Gui/Qt5GuiConfigExtras.cmake"
      find . \( -name "*.pri" -or -name "*.pc" -or -name "*.pri"  \) \
          -exec sed 's|/[^; ]*/lib\([^; ]*\)\.so|-l\1|g' {} -i ";"

      cat > "bin/qt.conf" <<EOF
      [Paths]
      Prefix = ..
      EOF

      cd "mkspecs/linux-clang/"
      mv "qmake.conf" "qmake.conf.tmp"
      grep -v ORCHESTRA_TMP "qmake.conf.tmp" > "qmake.conf"
      rm "qmake.conf.tmp"
    dependencies:
      - host-libcxx
      - ui/freetype
      - ui/libdrm
      - ui/mesa
      - ui/libxcb
      - ui/libinput
      - ui/libudev
      - ui/xcbutil-image
      - ui/xcbutil-renderutil
      - ui/xcbutil-wm
      - ui/xcbutil-keysyms
      - ui/libxshmfence
      - ui/libx11
      - ui/libxext
      - ui/xkbcommon
      - zlib
    build_dependencies:
      - host-cxx-toolchain
      - glibc
    #@ if/end ndebug == False:
    ndebug: false
  #@ end

#@ end

#@overlay/match by=overlay.all, expects=1
#@overlay/match-child-defaults missing_ok=True
---
components:
  ui/qt: #@ qt_component(False)
  windows/ui/qt: #@ qt_component(True)
